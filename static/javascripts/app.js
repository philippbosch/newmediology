// Generated by CoffeeScript 1.3.3
(function() {

  $(function() {
    var $content, $history, $prompt, answerDelay, converter;
    $prompt = $('#prompt');
    $history = $('#history');
    $content = $('#content');
    converter = new Showdown.converter;
    answerDelay = 1000;
    $history.data('log', []);
    $prompt.on('keypress', function(e, data) {
      var key, msg;
      key = e.keyCode || e.which;
      msg = $prompt.val().toLowerCase().trim();
      if (data || (key === 13 && msg.length)) {
        $history.trigger('message', {
          type: 'question',
          text: msg
        });
        return $history.trigger('question', msg);
      }
    }).on('webkitspeechchange', function(e) {
      return $prompt.trigger('keypress', $prompt.val());
    }).on('blur', function(e) {
      return window.setTimeout(function() {
        return $prompt[0].focus();
      }, 1);
    }).on('keydown', function(e) {
      var index, key;
      key = e.keyCode || e.which;
      switch (key) {
        case 38:
          index = $history.data('logIndex') - 1;
          break;
        case 40:
          index = $history.data('logIndex') + 1;
          break;
        default:
          $history.data('logIndex', $history.data('log').length);
          return;
      }
      if ($history.data('log')[index]) {
        $history.data('logIndex', index);
        return $prompt.val($history.data('log')[index]);
      } else if (key === 40) {
        $history.data('logIndex', $history.data('log').length);
        return $prompt.val("");
      }
    });
    $prompt.on('enterquestion', function(e, data) {
      var char, i, _i, _len, _ref, _results;
      $prompt.val('');
      i = 0;
      _ref = data.text;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        char = _ref[_i];
        _results.push((function() {
          var theChar, theI;
          theChar = char;
          theI = i;
          return setTimeout(function() {
            $prompt.val($prompt.val() + theChar);
            if (theI === data.text.length - 1) {
              return setTimeout(function() {
                var evt;
                evt = $.Event('keypress');
                evt.which = 13;
                evt.keyCode = 13;
                return $prompt.trigger(evt);
              }, 400);
            }
          }, ++i * 100 + Math.random() * 100);
        })());
      }
      return _results;
    });
    $history.on('message', function(e, data) {
      var $entry, $entryContainer, duration, entryHeight, log;
      if (data.type === 'question') {
        log = $history.data('log');
        log.push(data.text);
        $history.data('log', log);
        $history.data('logIndex', log.length);
      }
      $entryContainer = $('<li>');
      $entry = $('<div class="entry">');
      $entryContainer.addClass(data.type);
      $entryContainer.addClass(data.slug);
      if ('html' in data) {
        $entry.html(data.html);
      } else {
        $entry.text(data.text);
      }
      $entry.hide();
      $entryContainer.append($entry);
      $history.append($entryContainer);
      entryHeight = $entry.outerHeight();
      duration = 200;
      $entryContainer.animate({
        height: entryHeight
      }, {
        duration: duration,
        easing: "linear",
        step: function(now, fx) {
          return $history.scrollTop(99999999);
        },
        complete: function() {
          return $history.trigger('didscroll', {
            latestEntry: $entry
          });
        }
      });
      $entry.css({
        opacity: 0
      });
      $entry.show();
      $entry.animate({
        opacity: 1
      }, duration, "linear", function() {
        return $history.scrollTop(99999999);
      });
      return $prompt.val('');
    });
    $history.on('question', function(e, msg) {
      return $.ajax({
        url: '/',
        data: {
          question: msg
        },
        type: 'GET',
        dataType: 'json'
      }).success(function(data) {
        if (data.text) {
          $history.trigger('message', {
            type: 'answer',
            slug: data.slug,
            html: converter.makeHtml(data.text)
          });
        }
        if (data.page) {
          $content.trigger('showwebpage', {
            url: data.page
          });
        } else if (data.url) {
          $content.trigger('showwebpage', {
            url: data.url
          });
        }
        if (data.javascript) {
          eval("msg = (function(m) { " + data.javascript + " })(data.matches);");
          if (msg) {
            $history.trigger('message', {
              type: 'answer',
              slug: data.slug,
              html: converter.makeHtml(msg)
            });
          }
        }
        if (location.pathname !== ("/" + data.slug)) {
          return history.pushState({
            question: msg
          }, "", "/" + data.slug);
        }
      });
    });
    $history.on('clear', function() {
      $history.html('');
      $content.html('');
      return $history.trigger('question', 'welcome');
    });
    $(document).on('click', '#history a:not([href*="/"])', function(e) {
      var slug;
      e.preventDefault();
      slug = $(this).attr('href');
      if (Modernizr.history) {
        history.pushState(null, "", "/" + slug);
      } else {
        location.hash = '#{slug}';
      }
      $prompt.trigger('enterquestion', {
        text: slug
      });
      return false;
    });
    $content.on('updatecontent', function(e, data) {
      return $content.html(data.content);
    });
    $content.on('showwebpage', function(e, data) {
      var $iframe;
      $iframe = $('<iframe border="0" frameborder="0">');
      $iframe.attr('src', data.url);
      return $content.trigger('updatecontent', {
        content: $iframe
      });
    });
    $content.on('showtext', function(e, data) {
      var $div;
      $div = $('<div>');
      $div.html(data.text);
      return $content.trigger('updatecontent', {
        content: $div
      });
    });
    $(window).on('hashchange', function(e) {
      var question;
      question = location.hash.substr(location.hash.indexOf('#') + 1).replace(/\-/g, ' ');
      return $prompt.trigger('enterquestion', {
        text: question
      });
    });
    if (location.hash.length && location.hash !== '#') {
      $(window).trigger('hashchange');
    }
    $(window).on('popstate', function(e) {
      var question;
      $history.trigger('question', 'welcome');
      if (location.pathname !== "/") {
        if ('state' in e.originalEvent && (e.originalEvent.state != null) && 'question' in e.originalEvent.state) {
          question = e.originalEvent.state.question;
        } else {
          question = location.pathname.substr(1);
        }
        return $history.one('message', function() {
          return $prompt.trigger('enterquestion', {
            text: question
          });
        });
      }
    });
    if (!Modernizr.history) {
      $(window).trigger('popstate');
    }
    return $history.on('didscroll', function(e, data) {
      var $welcome;
      $welcome = $('li.welcome:first:not(.pinned)', this);
      if ($welcome.length && $welcome.position().top < 0) {
        $welcome.addClass('pinned');
        $welcome.css({
          top: '-50px'
        });
        return $welcome.animate({
          top: 0
        }, 500, 'linear');
      }
    });
  });

}).call(this);
